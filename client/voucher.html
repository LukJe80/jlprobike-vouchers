<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voucher – JL Pro Bike</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../supabaseClient.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Caveat:wght@600&display=swap');
    :root{--bg1:#0b0f17;--bg2:#111827;--line:rgba(255,255,255,.10);--text:#e5e7eb;--muted:rgba(229,231,235,.72);--accent:#ffffff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.08), transparent 55%),radial-gradient(900px 500px at 80% 0%, rgba(255,255,255,.06), transparent 50%),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);padding:28px}
    .wrap{max-width:980px;margin:auto}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;opacity:.95}
    .top a{color:var(--text);text-decoration:none;font-weight:900;font-size:13px;border:1px solid var(--line);padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.04)}
    .top a:hover{background:rgba(255,255,255,.07)}
    .ticket{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 24px 70px rgba(0,0,0,.45);background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));border:1px solid var(--line)}
    .ticketInner{display:grid;grid-template-columns:1.35fr .65fr;gap:0;min-height:320px}
    .left{padding:26px 26px 22px;background:radial-gradient(600px 240px at 20% 15%, rgba(255,255,255,.12), transparent 60%),radial-gradient(600px 240px at 95% 10%, rgba(255,255,255,.08), transparent 55%),linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45))}
    .right{padding:26px 22px 22px;border-left:1px dashed rgba(255,255,255,.20);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.25));position:relative}
    .right:before,.right:after{content:"";position:absolute;left:-10px;width:20px;height:20px;background:radial-gradient(circle at center, rgba(11,15,23,1) 0 55%, transparent 56%)}
    .right:before{top:28px}.right:after{bottom:28px}
    .brand{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brandLeft{display:flex;align-items:center;gap:12px}

    /* ✅ większe logo */
    .logo{width:86px;height:86px;border-radius:18px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain;background:transparent}

    .brandTitle{line-height:1.05}
    .brandTitle .name{font-weight:900;font-size:18px;letter-spacing:.3px}
    .brandTitle .sub{font-weight:700;font-size:12px;color:var(--muted);letter-spacing:.22em;text-transform:uppercase;margin-top:6px}
    .badge{font-weight:900;font-size:12px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);white-space:nowrap}
    .to{margin-top:18px;font-size:14px;color:var(--muted)}
    .to b{color:var(--text);font-weight:900}
    .amountRow{margin-top:10px;display:flex;align-items:flex-end;justify-content:space-between;gap:18px;flex-wrap:wrap}
    .amount{font-family:"Caveat",cursive;font-size:68px;line-height:1;letter-spacing:.5px;color:var(--accent);text-shadow:0 10px 30px rgba(0,0,0,.35);white-space:nowrap}
    .note{max-width:280px;font-size:12px;color:var(--muted);line-height:1.45;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20)}
    .meta{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    .meta .k{font-weight:800;color:rgba(229,231,235,.9)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .right h3{margin:0;font-size:13px;letter-spacing:.24em;text-transform:uppercase;color:rgba(229,231,235,.85)}
    .codeBox{margin-top:12px;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.20);padding:14px}
    .codeBig{font-size:22px;font-weight:900;letter-spacing:.10em;word-break:break-word;margin-top:8px}
    .qrHint{margin-top:12px;font-size:12px;color:var(--muted);line-height:1.45}
    .actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;font-weight:900;font-size:13px;cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);text-decoration:none}
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{background:rgba(255,255,255,.14)}
    .btn.primary:hover{background:rgba(255,255,255,.18)}
    .msg{margin-top:12px;font-size:13px;color:rgba(229,231,235,.85);min-height:18px}
    .err{color:#fecaca;font-weight:900}
    @media(max-width:860px){
      .ticketInner{grid-template-columns:1fr}
      .right{border-left:none;border-top:1px dashed rgba(255,255,255,.20)}
      .right:before,.right:after{display:none}
      .amount{font-size:58px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <a href="index.html">← Start</a>
      <!-- ✅ Opcja B: Panel pokazujemy tylko, gdy admin jest zalogowany -->
      <a id="panelLink" href="../panel.html" style="display:none;">Panel</a>
    </div>

    <div class="ticket">
      <div class="ticketInner">
        <div class="left">
          <div class="brand">
            <div class="brandLeft">
              <div class="logo">
                <img src="../assets/logo.png" alt="JL Pro Bike" onerror="this.style.display='none'">
              </div>
              <div class="brandTitle">
                <div class="name">JL Pro Bike</div>
                <div class="sub">voucher podarunkowy</div>
              </div>
            </div>
            <div class="badge" id="statusBadge">AKTYWNY</div>
          </div>

          <div class="to" id="toLine" style="display:none;">
            Dla: <b id="toName"></b>
          </div>

          <div class="amountRow">
            <div>
              <div style="font-size:12px;color:var(--muted);letter-spacing:.22em;text-transform:uppercase;">Wartość</div>
              <div class="amount" id="amount">—</div>
            </div>
            <div class="note">
              Voucher do realizacji w serwisie JL Pro Bike. Pokaż kod przy odbiorze usługi.
            </div>
          </div>

          <div class="meta">
            <div><span class="k">Kod:</span> <span class="mono" id="shortCode">—</span></div>
            <div><span class="k">Wystawiono:</span> <span class="mono" id="created">—</span></div>
            <div><span class="k">Status:</span> <span class="mono" id="status">—</span></div>
            <div><span class="k">Źródło:</span> <span class="mono">JL Pro Bike</span></div>
          </div>
        </div>

        <div class="right">
          <h3>Do użycia</h3>

          <div class="codeBox">
            <div style="font-size:12px;color:var(--muted);font-weight:800;">Kod vouchera</div>
            <div class="codeBig mono" id="codeBig">—</div>
          </div>

          <div class="qrHint">
            Ten link jest Twoim dostępem do vouchera. Możesz go skopiować lub wysłać SMS-em.
          </div>

          <div class="actions cardActions">
            <a class="btn primary" href="#" id="copyLink">Kopiuj link</a>
            <a class="btn" href="#" id="smsLink">SMS z linkiem</a>
            <button class="btn" id="printBtn" type="button">Drukuj</button>
          </div>

          <div class="msg" id="msg"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const sb = window.supabaseClient;

  const msg = document.getElementById("msg");
  const amountEl = document.getElementById("amount");
  const shortCodeEl = document.getElementById("shortCode");
  const codeBigEl = document.getElementById("codeBig");
  const statusEl = document.getElementById("status");
  const createdEl = document.getElementById("created");
  const statusBadge = document.getElementById("statusBadge");

  const toLine = document.getElementById("toLine");
  const toName = document.getElementById("toName");

  const copyLink = document.getElementById("copyLink");
  const smsLink = document.getElementById("smsLink");
  const printBtn = document.getElementById("printBtn");

  const panelLink = document.getElementById("panelLink");

  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  // ✅ Opcja B: pokaż Panel tylko, gdy jest sesja admina
  (async function showPanelOnlyForAdmin(){
    try{
      const { data:{ session } } = await sb.auth.getSession();
      if(session){
        panelLink.style.display = "";
      }else{
        panelLink.style.display = "none";
      }
    }catch(e){
      panelLink.style.display = "none";
    }
  })();

  if(!id){
    msg.innerHTML = `<span class="err">Brak parametru ?id=</span>`;
  } else {
    setupActions();
    loadVoucher();
  }

  function currentLink(){
    return location.origin + location.pathname + "?id=" + encodeURIComponent(id);
  }

  function setupActions(){
    const link = currentLink();
    smsLink.href = `sms:?&body=${encodeURIComponent("Twój voucher JL Pro Bike: " + link)}`;

    copyLink.addEventListener("click", async (e) => {
      e.preventDefault();
      try{
        await navigator.clipboard.writeText(link);
        msg.textContent = "Skopiowano link ✅";
      }catch{
        msg.textContent = "Nie mogę skopiować — skopiuj ręcznie: " + link;
      }
    });

    printBtn.addEventListener("click", () => window.print());
  }

  function fmtDate(iso){
    try{ return new Date(iso).toLocaleString("pl-PL"); }
    catch{ return iso || "—"; }
  }

  function setStatusBadge(s){
    const up = (s || "").toUpperCase();
    statusBadge.textContent = up || "—";
  }

  async function loadVoucher(){
    const { data, error } = await sb
      .from("vouchers")
      .select("id, amount_text, status, recipient_name, created_at, short_code")
      .eq("id", id)
      .single();

    if(error || !data){
      msg.innerHTML = `<span class="err">Nie znaleziono vouchera.</span> <span style="opacity:.75">${error?.message || ""}</span>`;
      return;
    }

    amountEl.textContent = data.amount_text || "—";
    const shownCode = data.short_code || data.id; // fallback, jeśli stary voucher bez short_code
    shortCodeEl.textContent = shownCode;
    codeBigEl.textContent = shownCode;

    statusEl.textContent = data.status || "—";
    createdEl.textContent = fmtDate(data.created_at);
    setStatusBadge(data.status);

    if(data.recipient_name && data.recipient_name.trim()){
      toName.textContent = data.recipient_name.trim();
      toLine.style.display = "block";
    }else{
      toLine.style.display = "none";
    }

    msg.textContent = "";
  }
</script>
</body>
</html>
